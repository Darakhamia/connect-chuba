// Connect Chuba - Discord Clone
// Prisma Schema for PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// ENUMS
// ==========================================

enum MemberRole {
  ADMIN
  MODERATOR
  GUEST
}

enum ChannelType {
  TEXT
  AUDIO
  VIDEO
}

enum UserStatus {
  ONLINE
  IDLE
  DND        // Do Not Disturb
  INVISIBLE
  OFFLINE
}

// ==========================================
// MODELS
// ==========================================

// Profile - Main user identity (synced with auth provider like Clerk)
model Profile {
  id        String   @id @default(uuid())
  oderId    String?  @unique @default(cuid()) // Public ID for adding friends (shorter, like ECHO#1234)
  userId    String   @unique // External auth provider ID (Clerk/NextAuth)
  name      String
  imageUrl  String   @db.Text
  email     String   @unique
  bio       String?  @db.Text
  status    UserStatus @default(OFFLINE)
  
  // Relations
  servers   Server[]   // Servers owned by this user
  members   Member[]   // Memberships in servers
  channels  Channel[]  // Channels created by this user
  
  // Friend relations
  friendRequestsSent     FriendRequest[] @relation("FriendRequestSender")
  friendRequestsReceived FriendRequest[] @relation("FriendRequestReceiver")
  friendshipsInitiated   Friendship[] @relation("FriendOne")
  friendshipsReceived    Friendship[] @relation("FriendTwo")
  
  // DM conversations (direct, not server-based)
  dmConversationsOne DMConversation[] @relation("DMProfileOne")
  dmConversationsTwo DMConversation[] @relation("DMProfileTwo")
  dmMessagesSent     DMMessage[]
  
  // Music relations
  musicSessionsCreated MusicSession[] @relation("MusicSessionCreator")
  tracksUploaded       Track[]
  queueItemsAdded      QueueItem[]
  musicPermissions     MusicPermission[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("profiles")
}

// Server - A community/guild
model Server {
  id         String   @id @default(uuid())
  name       String
  imageUrl   String   @db.Text
  inviteCode String   @unique
  
  // Owner relation
  profileId  String
  profile    Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  // Relations
  members    Member[]
  categories Category[]
  channels   Channel[]
  musicSessions MusicSession[]
  
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([profileId])
  @@map("servers")
}

// Category - Organizes channels within a server
model Category {
  id       String    @id @default(uuid())
  name     String
  position Int       @default(0)
  
  // Server relation
  serverId String
  server   Server    @relation(fields: [serverId], references: [id], onDelete: Cascade)
  
  // Relations
  channels Channel[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([serverId])
  @@map("categories")
}

// Member - User's membership in a server with role
model Member {
  id   String     @id @default(uuid())
  role MemberRole @default(GUEST)
  
  // Profile relation
  profileId String
  profile   Profile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  // Server relation
  serverId String
  server   Server  @relation(fields: [serverId], references: [id], onDelete: Cascade)
  
  // Relations
  messages              Message[]
  messageReactions      MessageReaction[]
  directMessagesSent    DirectMessage[] @relation("DirectMessageSender")
  directMessagesReceived DirectMessage[] @relation("DirectMessageReceiver")
  dmMessageReactions    DMMessageReaction[]
  
  // Conversations as initiator or receiver
  conversationsInitiated Conversation[] @relation("MemberOne")
  conversationsReceived  Conversation[] @relation("MemberTwo")
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([profileId, serverId])
  @@index([profileId])
  @@index([serverId])
  @@map("members")
}

// Channel - Text/Audio/Video channels within a server
model Channel {
  id       String      @id @default(uuid())
  name     String
  type     ChannelType @default(TEXT)
  position Int         @default(0)
  
  // Creator relation
  profileId String
  profile   Profile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  // Server relation
  serverId String
  server   Server  @relation(fields: [serverId], references: [id], onDelete: Cascade)
  
  // Category relation (optional - channel can be uncategorized)
  categoryId String?
  category   Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  
  // Relations
  messages Message[]
  musicSessions MusicSession[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([profileId])
  @@index([serverId])
  @@index([categoryId])
  @@map("channels")
}

// Message - Messages in text channels
model Message {
  id      String  @id @default(uuid())
  content String  @db.Text
  fileUrl String? @db.Text
  
  // Soft delete
  deleted Boolean @default(false)
  
  // Pinned message
  pinned Boolean @default(false)
  
  // Author relation
  memberId String
  member   Member @relation(fields: [memberId], references: [id], onDelete: Cascade)
  
  // Channel relation
  channelId String
  channel   Channel @relation(fields: [channelId], references: [id], onDelete: Cascade)
  
  // Reactions
  reactions MessageReaction[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([memberId])
  @@index([channelId])
  @@map("messages")
}

// MessageReaction - Reactions to messages
model MessageReaction {
  id String @id @default(uuid())
  
  // Emoji
  emoji String
  
  // Message relation
  messageId String
  message   Message @relation(fields: [messageId], references: [id], onDelete: Cascade)
  
  // Member who reacted
  memberId String
  member   Member @relation(fields: [memberId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())

  @@unique([messageId, memberId, emoji])
  @@index([messageId])
  @@index([memberId])
  @@map("message_reactions")
}

// Conversation - Direct message threads between two members
model Conversation {
  id String @id @default(uuid())
  
  // Two members in the conversation
  memberOneId String
  memberOne   Member @relation("MemberOne", fields: [memberOneId], references: [id], onDelete: Cascade)
  
  memberTwoId String
  memberTwo   Member @relation("MemberTwo", fields: [memberTwoId], references: [id], onDelete: Cascade)
  
  // Relations
  directMessages DirectMessage[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([memberOneId, memberTwoId])
  @@index([memberOneId])
  @@index([memberTwoId])
  @@map("conversations")
}

// DirectMessage - Messages in direct conversations (server-based)
model DirectMessage {
  id      String  @id @default(uuid())
  content String  @db.Text
  fileUrl String? @db.Text
  
  // Soft delete
  deleted Boolean @default(false)
  
  // Sender relation
  senderId String
  sender   Member @relation("DirectMessageSender", fields: [senderId], references: [id], onDelete: Cascade)
  
  // Receiver relation
  receiverId String
  receiver   Member @relation("DirectMessageReceiver", fields: [receiverId], references: [id], onDelete: Cascade)
  
  // Conversation relation
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([senderId])
  @@index([receiverId])
  @@index([conversationId])
  @@map("direct_messages")
}

// ==========================================
// FRIEND SYSTEM MODELS
// ==========================================

enum FriendRequestStatus {
  PENDING
  ACCEPTED
  DECLINED
}

// FriendRequest - Pending friend requests between profiles
model FriendRequest {
  id     String              @id @default(uuid())
  status FriendRequestStatus @default(PENDING)
  
  // Sender profile
  senderId String
  sender   Profile @relation("FriendRequestSender", fields: [senderId], references: [id], onDelete: Cascade)
  
  // Receiver profile
  receiverId String
  receiver   Profile @relation("FriendRequestReceiver", fields: [receiverId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([senderId, receiverId])
  @@index([senderId])
  @@index([receiverId])
  @@map("friend_requests")
}

// Friendship - Confirmed friendships between profiles
model Friendship {
  id String @id @default(uuid())
  
  // Two friends
  profileOneId String
  profileOne   Profile @relation("FriendOne", fields: [profileOneId], references: [id], onDelete: Cascade)
  
  profileTwoId String
  profileTwo   Profile @relation("FriendTwo", fields: [profileTwoId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())

  @@unique([profileOneId, profileTwoId])
  @@index([profileOneId])
  @@index([profileTwoId])
  @@map("friendships")
}

// DMConversation - Direct message conversations between profiles (not server-based)
model DMConversation {
  id String @id @default(uuid())
  
  // Two profiles in the conversation
  profileOneId String
  profileOne   Profile @relation("DMProfileOne", fields: [profileOneId], references: [id], onDelete: Cascade)
  
  profileTwoId String
  profileTwo   Profile @relation("DMProfileTwo", fields: [profileTwoId], references: [id], onDelete: Cascade)
  
  // Relations
  messages DMMessage[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([profileOneId, profileTwoId])
  @@index([profileOneId])
  @@index([profileTwoId])
  @@map("dm_conversations")
}

// DMMessage - Messages in DM conversations between profiles
model DMMessage {
  id      String  @id @default(uuid())
  content String  @db.Text
  fileUrl String? @db.Text
  
  // Soft delete
  deleted Boolean @default(false)
  
  // Pinned message
  pinned Boolean @default(false)
  
  // Sender profile
  profileId String
  profile   Profile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  // Conversation relation
  conversationId String
  conversation   DMConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  
  // Reactions
  reactions DMMessageReaction[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([profileId])
  @@index([conversationId])
  @@map("dm_messages")
}

// DMMessageReaction - Reactions to DM messages
model DMMessageReaction {
  id String @id @default(uuid())
  
  // Emoji
  emoji String
  
  // Message relation
  messageId String
  message   DMMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
  
  // Member who reacted (from any server they share)
  memberId String
  member   Member @relation(fields: [memberId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())

  @@unique([messageId, memberId, emoji])
  @@index([messageId])
  @@index([memberId])
  @@map("dm_message_reactions")
}

// ========================================
// MUSIC SYSTEM MODELS
// ========================================

enum MusicSessionState {
  IDLE
  PLAYING
  PAUSED
  LOADING
}

enum LoopMode {
  OFF
  ONE
  ALL
}

enum TrackSource {
  YOUTUBE
  SPOTIFY
  APPLE_MUSIC
  SOUNDCLOUD
  UPLOADED
}

// MusicSession - Music playback session tied to a voice channel
model MusicSession {
  id              String            @id @default(uuid())
  serverId        String
  voiceChannelId  String
  createdById     String
  state           MusicSessionState @default(IDLE)
  currentTrackId  String?
  startedAt       DateTime?
  offsetMs        Int               @default(0)
  loopMode        LoopMode          @default(OFF)
  shuffle         Boolean           @default(false)
  volume          Int               @default(100)
  djMode          Boolean           @default(false)
  
  // Relations
  server          Server            @relation(fields: [serverId], references: [id], onDelete: Cascade)
  channel         Channel           @relation(fields: [voiceChannelId], references: [id], onDelete: Cascade)
  createdBy       Profile           @relation("MusicSessionCreator", fields: [createdById], references: [id], onDelete: Cascade)
  currentTrack    Track?            @relation("CurrentTrack", fields: [currentTrackId], references: [id], onDelete: SetNull)
  queue           QueueItem[]
  permissions     MusicPermission[]
  
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@unique([serverId, voiceChannelId])
  @@index([serverId])
  @@index([voiceChannelId])
  @@index([createdById])
  @@map("music_sessions")
}

// Track - Cached music track metadata
model Track {
  id              String      @id @default(uuid())
  source          TrackSource
  sourceId        String      // YouTube video ID, Spotify URI, etc.
  title           String
  artist          String?
  durationMs      Int
  thumbnailUrl    String?     @db.Text
  originalUrl     String      @db.Text
  metadata        Json?       // Extra metadata (genre, album, etc.)
  
  // For uploaded files
  uploadedFileUrl String?     @db.Text
  uploadedById    String?
  uploadedBy      Profile?    @relation(fields: [uploadedById], references: [id], onDelete: SetNull)
  
  // Relations
  sessionsAsCurrent MusicSession[] @relation("CurrentTrack")
  queueItems        QueueItem[]
  
  createdAt       DateTime    @default(now())
  
  @@unique([source, sourceId])
  @@index([source])
  @@index([uploadedById])
  @@map("tracks")
}

// QueueItem - Track in a music session queue
model QueueItem {
  id         String       @id @default(uuid())
  sessionId  String
  trackId    String
  addedById  String
  position   Int
  
  // Relations
  session    MusicSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  track      Track        @relation(fields: [trackId], references: [id], onDelete: Cascade)
  addedBy    Profile      @relation(fields: [addedById], references: [id], onDelete: Cascade)
  
  createdAt  DateTime     @default(now())
  
  @@index([sessionId, position])
  @@index([trackId])
  @@index([addedById])
  @@map("queue_items")
}

// MusicPermission - DJ permissions for music sessions
model MusicPermission {
  id         String       @id @default(uuid())
  sessionId  String
  profileId  String
  canControl Boolean      @default(true)
  
  // Relations
  session    MusicSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  profile    Profile      @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  createdAt  DateTime     @default(now())
  
  @@unique([sessionId, profileId])
  @@index([sessionId])
  @@index([profileId])
  @@map("music_permissions")
}
